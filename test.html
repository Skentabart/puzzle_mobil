<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puzzle Game</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    h1 {
      color: white;
      margin-bottom: 24px;
      font-size: 36px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .level-display {
      color: white;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
      justify-content: center;
    }

    label {
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    button, select, input[type="file"] {
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      border: none;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s;
      background: white;
      color: #333;
      cursor: pointer;
    }

    button:hover, select:hover {
      background: #e8e8e8;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    select {
      min-width: 100px;
    }

    .sound-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
      color: white;
    }

    .sound-controls label {
      margin: 0;
      color: white;
      font-size: 14px;
    }

    .sound-controls input[type="file"] {
      padding: 6px 12px;
      font-size: 12px;
    }

    #puzzle-container {
      position: relative;
      width: 90vw;
      max-width: 500px;
      aspect-ratio: 1 / 1;
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      touch-action: none;
      -webkit-backface-visibility: hidden;
      -webkit-perspective: 1000;
    }

    /* Puzzle pieces container */
    .puzzle-pieces-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Each puzzle piece has subtle blur */
    .puzzle-piece {
      position: absolute;
      background-repeat: no-repeat;
      background-size: cover;
      border: 1px solid rgba(0,0,0,0.1);
      user-select: none;
      cursor: grab;
      transition: box-shadow 0.1s, filter 0.8s;
      z-index: 2;
      opacity: 1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      filter: blur(2px);
    }

    .puzzle-piece:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .puzzle-piece.dragging {
      cursor: grabbing;
      opacity: 0.95;
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      z-index: 100 !important;
      filter: blur(0px);
    }

    /* When puzzle is complete - show sharp pieces */
    .puzzle-piece.completed {
      animation: fadeOut 0.8s ease-out forwards;
      z-index: 0;
      filter: blur(0px);
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
        z-index: 2;
      }
      100% {
        opacity: 0;
        z-index: 0;
      }
    }

    /* Final image overlay - shown after completion */
    #final-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      z-index: 100;
      opacity: 0;
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
    }

    #final-image.show {
      opacity: 1;
      transform: scale(1.1);
    }

    #status {
      color: white;
      font-weight: bold;
      font-size: 28px;
      min-height: 30px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      text-align: center;
      margin-bottom: 20px;
      animation: popIn 0.5s ease-out;
    }

    @keyframes popIn {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    #error-message {
      color: #ffcccc;
      font-size: 14px;
      text-align: center;
      margin-bottom: 10px;
    }

    .progress-bar {
      width: 300px;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 4px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #4ecca3;
      border-radius: 4px;
      transition: width 0.3s;
      width: 0%;
    }

    .button-container {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    #nextLevelBtn {
      padding: 14px 40px;
      font-size: 16px;
      background: linear-gradient(135deg, #4ecca3 0%, #3da995 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 12px rgba(78, 204, 163, 0.4);
      transition: all 0.2s;
    }

    #nextLevelBtn:hover {
      background: linear-gradient(135deg, #3da995 0%, #2d9085 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(78, 204, 163, 0.5);
    }

    #nextLevelBtn:active {
      transform: translateY(0);
    }

    #nextLevelBtn.show {
      display: block;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #completionMessage {
      color: white;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      text-align: center;
      display: none;
      animation: fadeIn 0.6s ease-out;
    }

    #completionMessage.show {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <h1>ðŸ§© Puzzle Game</h1>
  
  <div class="level-display">
    Level: <span id="currentLevel">1</span> | Grid: <span id="gridDisplay">3x3</span>
  </div>

  <div class="controls">
    <button id="shuffle">Shuffle</button>
    <button id="newGame">Restart</button>

    <span style="color: white; font-weight: bold;">or</span>

    <input type="file" id="imageUpload" accept="image/jpeg,image/png,image/jpg" title="Upload custom image (JPG or PNG)">
  </div>

  <div class="sound-controls">
    <label>ðŸ”Š Move Sound:</label>
    <input type="file" id="moveSound" accept="audio/*" title="Upload move sound">
    
    <label>ðŸ”Š Complete Sound:</label>
    <input type="file" id="completeSound" accept="audio/*" title="Upload complete sound">
  </div>

  <div id="error-message"></div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <div id="puzzle-container">
    <div class="puzzle-pieces-wrapper"></div>
    <div id="final-image"></div>
  </div>

  <div id="status"></div>
  <div id="completionMessage"></div>

  <div class="button-container">
    <button id="nextLevelBtn">Next Level â†’</button>
  </div>

  <script>
    // Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð²ÑƒÐºÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· Web Audio API
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let moveSoundUrl = null;
    let completeSoundUrl = null;

    // Ð—Ð²ÑƒÐº Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°Ð·Ð»Ð° (move) - Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    function playMoveSound() {
      if (moveSoundUrl) {
        playAudioFile(moveSoundUrl);
      } else {
        playDefaultMoveSound();
      }
    }

    // Ð—Ð²ÑƒÐº Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿Ð°Ð·Ð»Ð° (all) - Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    function playCompleteSound() {
      if (completeSoundUrl) {
        playAudioFile(completeSoundUrl);
      } else {
        playDefaultCompleteSound();
      }
    }

    // Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð·Ð²ÑƒÐºÐ¾Ð²Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
    function playAudioFile(url) {
      const audio = new Audio(url);
      audio.volume = 0.5;
      audio.play().catch(err => console.log('Audio play error:', err));
    }

    // Ð—Ð²ÑƒÐº Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°Ð·Ð»Ð° Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (ÑÐ¸Ð½Ñ‚ÐµÐ·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹)
    function playDefaultMoveSound() {
      try {
        const now = audioContext.currentTime;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
        
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        
        osc.start(now);
        osc.stop(now + 0.1);
      } catch(e) {
        console.log('Audio context error:', e);
      }
    }

    // Ð—Ð²ÑƒÐº Ð´Ð»Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿Ð°Ð·Ð»Ð° Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (ÑÐ¸Ð½Ñ‚ÐµÐ·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹)
    function playDefaultCompleteSound() {
      try {
        const now = audioContext.currentTime;
        
        // ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ‚Ð¾Ð½
        const osc1 = audioContext.createOscillator();
        const gain1 = audioContext.createGain();
        osc1.connect(gain1);
        gain1.connect(audioContext.destination);
        
        osc1.frequency.setValueAtTime(523, now);
        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
        osc1.start(now);
        osc1.stop(now + 0.2);
        
        // Ð’Ñ‚Ð¾Ñ€Ð¾Ð¹ Ñ‚Ð¾Ð½
        const osc2 = audioContext.createOscillator();
        const gain2 = audioContext.createGain();
        osc2.connect(gain2);
        gain2.connect(audioContext.destination);
        
        osc2.frequency.setValueAtTime(659, now + 0.15);
        gain2.gain.setValueAtTime(0.3, now + 0.15);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
        osc2.start(now + 0.15);
        osc2.stop(now + 0.35);
        
        // Ð¢Ñ€ÐµÑ‚Ð¸Ð¹ Ñ‚Ð¾Ð½
        const osc3 = audioContext.createOscillator();
        const gain3 = audioContext.createGain();
        osc3.connect(gain3);
        gain3.connect(audioContext.destination);
        
        osc3.frequency.setValueAtTime(784, now + 0.3);
        gain3.gain.setValueAtTime(0.3, now + 0.3);
        gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
        osc3.start(now + 0.3);
        osc3.stop(now + 0.6);
      } catch(e) {
        console.log('Audio context error:', e);
      }
    }

    // 10 Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
    const testImages = [
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g1%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%2322c55e;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%230891b2;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g1)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g2%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%23ef4444;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%23eab308;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g2)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g3%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%23a855f7;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%23ec4899;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g3)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g4%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%23f97316;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%23991b1b;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g4)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g5%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%232563eb;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%2306b6d4;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g5)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g6%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%2316a34a;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%23addc2f;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g6)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g7%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%234f46e5;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%233b82f6;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g7)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g8%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%230d9488;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%2315803d;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g8)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g9%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%23f43f5e;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%23b91c1c;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g9)%22/%3E%3C/svg%3E',
      'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 500 500%22%3E%3Cdefs%3E%3ClinearGradient id=%22g10%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22%3E%3Cstop offset=%220%25%22 style=%22stop-color:%23475569;stop-opacity:1%22 /%3E%3Cstop offset=%22100%25%22 style=%22stop-color:%23d1d5db;stop-opacity:1%22 /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width=%22500%22 height=%22500%22 fill=%22url(%23g10)%22/%3E%3C/svg%3E'
    ];

    const container = document.getElementById("puzzle-container");
    const piecesWrapper = document.querySelector(".puzzle-pieces-wrapper");
    const finalImage = document.getElementById("final-image");
    const imageInput = document.getElementById("imageUpload");
    const moveSoundInput = document.getElementById("moveSound");
    const completeSoundInput = document.getElementById("completeSound");
    const shuffleButton = document.getElementById("shuffle");
    const newGameButton = document.getElementById("newGame");
    const nextLevelBtn = document.getElementById("nextLevelBtn");
    const statusDiv = document.getElementById("status");
    const completionMessage = document.getElementById("completionMessage");
    const errorDiv = document.getElementById("error-message");
    const currentLevelDisplay = document.getElementById("currentLevel");
    const gridDisplay = document.getElementById("gridDisplay");
    const progressFill = document.getElementById("progressFill");

    let currentLevel = 1;
    let imageSrc = testImages[0];
    let size = 3;
    let pieces = [];
    let draggedIndex = null;
    let offsetX = 0;
    let offsetY = 0;
    let isGameComplete = false;

    function getGridSize(level) {
      if (level >= 1 && level <= 10) return 3;
      if (level >= 11 && level <= 20) return 4;
      if (level >= 21 && level <= 30) return 5;
      return 6;
    }

    function getImageIndex(level) {
      return ((level - 1) % 10);
    }

    // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð²ÑƒÐºÐ¾Ð²
    moveSoundInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
          moveSoundUrl = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    completeSoundInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
          completeSoundUrl = evt.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    function loadLevel(level) {
      if (level > 30) {
        statusDiv.textContent = "All levels completed!";
        completionMessage.textContent = "Congratulations! You finished all 30 levels!";
        completionMessage.classList.add("show");
        nextLevelBtn.classList.remove("show");
        return;
      }

      currentLevel = level;
      currentLevelDisplay.textContent = currentLevel;
      
      size = getGridSize(level);
      const imageIndex = getImageIndex(level);
      
      gridDisplay.textContent = size + "x" + size;
      
      const jpgPath = "images/" + (imageIndex + 1) + ".jpg";
      const pngPath = "images/" + (imageIndex + 1) + ".png";
      
      imageSrc = testImages[imageIndex];
      
      const img = new Image();
      
      img.onload = function() {
        imageSrc = jpgPath;
        finalImage.style.backgroundImage = "url('" + imageSrc + "')";
        createPuzzle();
        errorDiv.textContent = '';
      };
      
      img.onerror = function() {
        const imgPng = new Image();
        imgPng.onload = function() {
          imageSrc = pngPath;
          finalImage.style.backgroundImage = "url('" + imageSrc + "')";
          createPuzzle();
          errorDiv.textContent = '';
        };
        imgPng.onerror = function() {
          imageSrc = testImages[imageIndex];
          finalImage.style.backgroundImage = "url('" + imageSrc + "')";
          createPuzzle();
          errorDiv.textContent = 'Using default image. Place images/1.jpg to images/10.jpg in your folder.';
        };
        imgPng.src = pngPath;
      };
      
      img.src = jpgPath;
      
      finalImage.classList.remove("show");
      
      isGameComplete = false;
      nextLevelBtn.classList.remove("show");
      statusDiv.textContent = '';
      completionMessage.classList.remove("show");
    }

    imageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
          imageSrc = evt.target.result;
          finalImage.style.backgroundImage = "url('" + imageSrc + "')";
          createPuzzle();
          errorDiv.textContent = '';
        };
        reader.readAsDataURL(file);
      }
    });

    shuffleButton.addEventListener("click", () => {
      if (!isGameComplete) {
        pieces = shuffleArray(pieces);
        drawPuzzle();
        statusDiv.textContent = '';
      }
    });

    newGameButton.addEventListener("click", () => {
      createPuzzle();
    });

    nextLevelBtn.addEventListener("click", () => {
      loadLevel(currentLevel + 1);
    });

    function createPuzzle() {
      statusDiv.textContent = '';
      completionMessage.classList.remove("show");
      pieces = [];

      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          pieces.push({ x, y });
        }
      }

      pieces = shuffleArray(pieces);
      drawPuzzle();
      updateProgress();
      isGameComplete = false;
      nextLevelBtn.classList.remove("show");
    }

    function drawPuzzle() {
      const containerSize = container.clientWidth;
      const pieceSize = containerSize / size;
      
      piecesWrapper.innerHTML = '';

      pieces.forEach((piece, index) => {
        const div = document.createElement("div");
        div.className = "puzzle-piece";
        
        div.style.width = pieceSize + "px";
        div.style.height = pieceSize + "px";
        div.style.left = ((index % size) * pieceSize) + "px";
        div.style.top = (Math.floor(index / size) * pieceSize) + "px";
        
        div.style.backgroundImage = "url('" + imageSrc + "')";
        div.style.backgroundSize = containerSize + "px " + containerSize + "px";
        div.style.backgroundPosition = 
          (-piece.x * pieceSize) + "px " + (-piece.y * pieceSize) + "px";

        div.dataset.index = index;

        div.addEventListener("mousedown", startDrag);
        div.addEventListener("touchstart", startDrag, false);

        piecesWrapper.appendChild(div);
      });

      document.addEventListener("mousemove", moveDrag, false);
      document.addEventListener("touchmove", moveDrag, false);
      document.addEventListener("mouseup", endDrag, false);
      document.addEventListener("touchend", endDrag, false);
    }

    function startDrag(e) {
      if (isGameComplete) return;
      
      draggedIndex = Number(e.target.dataset.index);
      const rect = e.target.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      
      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;
      
      e.target.classList.add("dragging");
    }

    function moveDrag(e) {
      if (draggedIndex === null || isGameComplete) return;

      const piece = document.querySelector("[data-index='" + draggedIndex + "']");
      if (!piece) return;

      e.preventDefault();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      
      const containerRect = container.getBoundingClientRect();
      let x = clientX - containerRect.left - offsetX;
      let y = clientY - containerRect.top - offsetY;

      x = Math.max(0, Math.min(x, containerRect.width - piece.offsetWidth));
      y = Math.max(0, Math.min(y, containerRect.height - piece.offsetHeight));

      piece.style.left = x + "px";
      piece.style.top = y + "px";
    }

    function endDrag(e) {
      if (draggedIndex === null) return;

      const piece = document.querySelector("[data-index='" + draggedIndex + "']");
      if (!piece) {
        draggedIndex = null;
        return;
      }

      piece.classList.remove("dragging");

      const containerSize = container.clientWidth;
      const pieceSize = containerSize / size;
      
      const x = parseFloat(piece.style.left);
      const y = parseFloat(piece.style.top);
      
      const newCol = Math.round(x / pieceSize);
      const newRow = Math.round(y / pieceSize);
      const newIndex = newRow * size + newCol;
      
      if (newIndex >= 0 && newIndex < pieces.length && newIndex !== draggedIndex) {
        swapPieces(draggedIndex, newIndex);
        playMoveSound();
      } else {
        drawPuzzle();
      }
      
      draggedIndex = null;
      updateProgress();
      checkVictory();
    }

    function swapPieces(i, j) {
      const temp = pieces[i];
      pieces[i] = pieces[j];
      pieces[j] = temp;
      drawPuzzle();
    }

    function shuffleArray(array) {
      const shuffled = array.slice();
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function updateProgress() {
      let correctCount = 0;
      for (let i = 0; i < pieces.length; i++) {
        const correctX = i % size;
        const correctY = Math.floor(i / size);
        if (pieces[i].x === correctX && pieces[i].y === correctY) {
          correctCount++;
        }
      }
      const progress = (correctCount / pieces.length) * 100;
      progressFill.style.width = progress + "%";
    }

    function checkVictory() {
      if (isGameComplete) return;

      let isWin = true;
      for (let i = 0; i < pieces.length; i++) {
        const correctX = i % size;
        const correctY = Math.floor(i / size);
        if (pieces[i].x !== correctX || pieces[i].y !== correctY) {
          isWin = false;
          break;
        }
      }

      if (isWin) {
        isGameComplete = true;
        playCompleteSound();
        
        const puzzlePieces = document.querySelectorAll(".puzzle-piece");
        puzzlePieces.forEach((p, index) => {
          setTimeout(() => {
            p.classList.add("completed");
          }, index * 50);
        });

        setTimeout(() => {
          finalImage.classList.add("show");
        }, 400);
        
        statusDiv.textContent = "âœ¨ Level " + currentLevel + " Complete! âœ¨";
        completionMessage.textContent = "Fantastic! You solved Level " + currentLevel + "!";
        completionMessage.classList.add("show");
        
        setTimeout(() => {
          nextLevelBtn.classList.add("show");
        }, 1000);
      }
    }

    window.addEventListener("resize", () => {
      if (!isGameComplete) {
        drawPuzzle();
      }
    });

    loadLevel(1);
  </script>
</body>
</html>
