<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>

body{
margin:0;
background:#111;
font-family:Arial;
display:flex;
flex-direction:column;
align-items:center;
color:white;
}

#game{
position:relative;
width:95vw;
max-width:500px;
aspect-ratio:1/1;
margin-top:10px;
overflow:hidden;
border-radius:12px;
}

#imageLayer{
position:absolute;
width:100%;
height:100%;
background-size:cover;
filter:blur(20px);
transition:1.5s;
z-index:1;
}

.piece{
position:absolute;
background-repeat:no-repeat;
touch-action:none;
z-index:2;
}

button{
margin-top:10px;
padding:12px 20px;
font-size:18px;
border:none;
border-radius:10px;
cursor:pointer;
}

</style>
</head>

<body>

<h3>Blur Puzzle</h3>
<button id="newGameBtn">Новая игра</button>

<div id="game">
<div id="imageLayer"></div>
</div>

<script>

const images=[];
for(let i=1;i<=10;i++){
 images.push("images/"+i+".jpg");
}

const grid=3;

let pieces=[];
let active=null;

document.getElementById("newGameBtn").onclick=startGame;

function startGame(){

const game=document.getElementById("game");

// удаляем старые пазлы
document.querySelectorAll(".piece").forEach(e=>e.remove());

const imgSrc=images[Math.floor(Math.random()*images.length)];

const img=new Image();
img.src=imgSrc;

img.onload=()=>{

const size=game.clientWidth;
const pieceSize=size/grid;

const imageLayer=document.getElementById("imageLayer");
imageLayer.style.backgroundImage=`url(${imgSrc})`;
imageLayer.style.filter="blur(20px)";

pieces=[];

for(let y=0;y<grid;y++){
for(let x=0;x<grid;x++){

const div=document.createElement("div");

div.className="piece";

div.style.width=pieceSize+"px";
div.style.height=pieceSize+"px";

div.style.backgroundImage=`url(${imgSrc})`;
div.style.backgroundSize=size+"px "+size+"px";
div.style.backgroundPosition=
`-${x*pieceSize}px -${y*pieceSize}px`;

const correctX=x*pieceSize;
const correctY=y*pieceSize;

div.dataset.correctX=correctX;
div.dataset.correctY=correctY;

div.style.left=Math.random()*(size-pieceSize)+"px";
div.style.top=Math.random()*(size-pieceSize)+"px";

enableDrag(div);

game.appendChild(div);

pieces.push(div);

}
}

}

}

function enableDrag(el){

let offsetX,offsetY;

el.onpointerdown=(e)=>{
active=el;
offsetX=e.offsetX;
offsetY=e.offsetY;
el.setPointerCapture(e.pointerId);
};

el.onpointermove=(e)=>{

if(active!==el) return;

const rect=document.getElementById("game").getBoundingClientRect();

el.style.left=(e.clientX-rect.left-offsetX)+"px";
el.style.top=(e.clientY-rect.top-offsetY)+"px";

};

el.onpointerup=()=>{
active=null;
snap(el);
checkWin();
};

}

function snap(el){

const snap=25;

const cx=parseFloat(el.dataset.correctX);
const cy=parseFloat(el.dataset.correctY);

const x=parseFloat(el.style.left);
const y=parseFloat(el.style.top);

if(Math.abs(x-cx)<snap && Math.abs(y-cy)<snap){

el.style.left=cx+"px";
el.style.top=cy+"px";
el.style.pointerEvents="none";

}

}

function checkWin(){

for(let p of pieces){
 if(p.style.pointerEvents!=="none") return;
}

// плавное разблюривание
document.getElementById("imageLayer").style.filter="blur(0px)";

setTimeout(()=>alert("Пазл собран!"),400);

}

// старт сразу
startGame();

</script>

</body>
</html>
